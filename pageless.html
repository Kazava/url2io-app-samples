<!DOCTYPE html>
<html lang='zh-CN'>
<head>
  <meta http-equiv='Content-Type' content='text/html; charset=utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <title>pageless | URL2</title>
  <link rel="stylesheet" href="static/css/typo.css" />
  <style type="text/css">
    html {
      font-size: 110%;
    }
    body {
      margin: 0px;
    }
    .header {
      padding-bottom: 20px;
      height: 100px;
    }
    .danlv {
      background-color: #2B9646;
    }
    .header h1 {
      margin-bottom: 10px;
      text-align: center;
      color: white;
    }
    .ft {
      position: absolute;
      width: 32px;
      height: 20px;
      top: 0px;
      left: -36px;
      font-size: 10px;
      text-align: center;
      background: #d1d0c8
    }
    .search-box {
      height: 28px;
      border: 1px solid #cccccc;
      padding: 0px 6px;
      margin: 0px !important;
      width: 650px;
    }
    .search-box:focus {
      border: 1px solid #4d90fe; 
      outline: 0;
      outline: thin dotted \9;
      -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,0.075), 0 0 6px rgba(82,168,236,0.6);
         -moz-box-shadow: inset 0 1px 1px rgba(0,0,0,0.075), 0 0 6px rgba(82,168,236,0.6);
              box-shadow: inset 0 1px 1px rgba(0,0,0,0.075), 0 0 6px rgba(82,168,236,0.6);
    }
    .search-box:hover {
      border: 1px solid #d9d9d9;
      outline: 0;
      outline: thin dotted \9;
    }
    button#btn-go {
      height: 30px;
      width: 30px;
      border: none;
      padding: 6px;
      padding-top: 4px;
      padding-bottom: 4px;
      margin: 0px;
      opacity: 0.9;
    }
    button#btn-go:hover {
      opacity: 1;
    }
    div.search {
      position: relative;
      text-align: center;
      width: 700px;
      margin: auto;
    }    
    .container {
      padding: 20px;
      margin-right: auto;
      margin-left: auto;
      width: 700px;
    }
    .content img {
      display: block;
      max-width: 100%;
    }
    .article h1.title {
      font-family: Georgia,"Times New Roman",Times,"Kai","Kaiti SC","KaiTi","BiauKai","楷体","楷体_GB2312",serif;
      font-weight: 700;
      font-size: 39px;
    }
    .page {
      position: relative;
    }
    .footer {
      color: #2B9646;
    }
    .gotop {
      position: fixed;
      font-size: 0.8em;
      bottom: 30px;
      right: 10%;
    }
    .ribbon {
      background: #a00;
      overflow: hidden;
      position: absolute;
      right: -3em;
      top: 2.5em;
      -webkit-transform: rotate(45deg);
         -moz-transform: rotate(45deg);
          -ms-transform: rotate(45deg);
           -o-transform: rotate(45deg);
              transform: rotate(45deg);
    }
    .ribbon a {
      color: #fff;
      display: block;
      font: bold 81.25% 'Helvetiva Neue', Helvetica, Arial, sans-serif;
      margin: 0.05em 0 0.075em 0;
      padding: 0.5em 3.5em;
      text-align: center;
      text-decoration: none;
    }
    .fork-me-on-github {
      position: absolute;
      top: 0px;
      right: 0px;
    }
    .error h2 {
      color: red;
    }
    /* url list pane */
    #url-list-pane {
      position: fixed;
      width: 280px;
      left: -285px;
      border: 1px solid black;
      background-color: white;
      z-index: 1000;
    }
    .close {
      float: right;
      cursor: pointer;
      font-size: 13px;
      font-weight: bold;
      padding-right: 5px;
    }
    .close:hover {
      color: red;
    }
    .url-list {
      list-style: none;
      font-size: 13px;
    }
    .url-cell {
      border-top: 1px dotted;
      padding: 5px;
      cursor: pointer;
    }
    .url-cell:hover {
      background-color: #EEEEEE;
    }
    .show-pane {
      position: fixed;
      width: 40px;
      top: 50%;
      margin-top: -50px;
      left: -35px;
      background-color: #2AAF4C;
      color: #fff;
      text-align: right;
      text-decoration: none;
      font-weight: bold;
      font-size: 14px;
      padding: 20px 5px;
      -webkit-border-radius: 5px;
         -moz-border-radius: 5px;
              border-radius: 5px;
      z-index: 900;
      -webkit-transition:all 0.2s linear !important;
         -moz-transition:all 0.2s linear !important;
          -ms-transition:all 0.2s linear !important;
           -o-transition:all 0.2s linear !important;
              transition:all 0.2s linear !important;
    }
    .show-pane:hover {
      text-decoration: none;
      left: -20px;
    }

    /* Responsive *\
    \* ========== */
    @media (max-width: 767px) {
      .search-box {
        width: 80%;
      }
      .container {
        width: auto;
      }
      div.search {
        width: auto;
      }
      .article h1.title {
        font-size: 32px;
      }
      .ft {
        position: relative;
        left: 0px;
      }
      .gotop {
        right: 10px;
      }
    }
  </style>
</head>
<body>
<div class='header danlv'>
  <a class='fork-me-on-github' href="https://github.com/url2/url2-app-samples" target='_blank'>
    <img style='zoom: 0.8' src="static/img/fork-me-on-github.png" alt="" />
  </a>
  <h1>Pageless</h1>
  <div class='search'>
    <form id='fs'>
      <input id="url" name='url' class='search-box' type="text" placeholder='输入url...' value='http://typo.sofish.de'/>
      <button id='btn-go' onclick='add_article($("#url").val());return false;'>GO</button>
  </form>
  </div>
</div>
<!-- url-list-pane 
     ============= -->
<a href="javascript:void(0);" class='show-pane'>&gt;</a>
<div id="url-list-pane">
  <div class="close">x</div>
  <center><h4><b>测试url</b></h4></center>
  <h5 style='color:#66bc4e'>下一页</h5>
  <ul class="url-list">
    <li class="url-cell" src-data="http://tech.sina.com.cn/i/2010-08-18/19554560539.shtml">Web已死 Internet永生 -《连线》杂志</li>
    <li class="url-cell" src-data="http://www.qiushibaike.com/">8小时内最尴尬糗事::糗事百科</li>
    <li class="url-cell" src-data="http://www.36kr.com">36氪 | 关注互联网创业</li>
  </ul>
  <h5 style='color:#66bc4e'>正文提取</h5>
  <ul class="url-list">
    <li class="url-cell" src-data="http://select.yeeyan.org/view/338874/352344">别了,Google Reader</li>
    <li class="url-cell" src-data="http://typo.sofish.de/">中文网页重设与排版：TYPO.CSS</li>
    <li class="url-cell" src-data="http://www.36kr.com/p/208498.html">Oculus Rift的性感极客们到底是如何破解晕眩感的</li>
    <li class="url-cell" src-data="http://www.36kr.com/p/208636.html">为什么这八家机器人公司可以吸引Andy Rubin，你了解它们吗？</li>
    <li class="url-cell" src-data="http://www.36kr.com/p/167423.html">永不离线: 可穿戴式计算技术是移动的未来？</li>
    <li class="url-cell" src-data="/docs">URL2 API 文档</li>
  </ul>
</div>

<!-- article 
     ======= -->
<div class="container typo">
  <div id="article" class='article'>
    <!-- pages -->
  </div>
  <img src="static/img/loading.gif" id='loading' alt="" style='display:none;margin:auto;left:0;right:0;'/>
</div>
<!-- go to top -->
<div class='gotop'>
  <a href='#'>↑回顶部</a>
</div>

<!-- 模板  article -->
<script type="text/template" id='article_template'>
  <div id="pageless-wrap">
    <center><h1 class="title">{{title}}</h1></center>
     {{>page}}
     <div><a href="{{url}}" target='__blank'>原始地址</a></div>
     <!-- footer -->
     <div class='footer'>
       <hr>
       <center>Powered by <a href="/" target='_blank'>URL2</a></center>
     </div>
  </div>
</script>
<!-- 模板 page -->
<script type="text/template" id="page_template" >
  <div id="page{{page_number}}" class='content page'>
    <div class='ft'> {{page_number}} </div>
    {{&content}}
  </div>
</script>
<!-- 模板 错误提示 -->
<script type="text/template" id='error_template'>
  <div class='error'>
    <h2>Oops, wrong</h2>
    <table>
      <tr><th>ARGUMENT</th><th>DESCRIPTION</th></tr>
      <tr><td>error type</td><td>: "{{error}}"</td></tr>
      <tr><td>message</td><td>: "{{msg}}"</td></tr>
      <tr><td>url</td><td>: "{{url}}"</td></tr>
      {{#code}}<tr><td>code</td><td>: "{{code}}"</td></tr>{{/code}}
      {{#type}}<tr><td>type</td><td>: "{{type}}"</td></tr>{{/type}}
    </table>
  </div>
</script>
<!-- js -->
<script type="text/javascript" src='static/js/jquery-1.9.1.min.js'></script>
<script type='text/javascript' src='static/js/jquery.mustache.js'></script>
<script type="text/javascript">
  var page_number;

  // 调用url2article api获得数据
  function get_data(url, callback, repeat) {
    var repeat = repeat || (repeat == 0 ? 0 : 1);
    $.ajax({
        'type': 'get',
        'url': 'http://url2api.sinaapp.com/article',
      //'url': 'http://localhost:8080/article',
        'dataType': 'jsonp',
        'timeout': 30000,
        'data': {
          'url': url, 
          'fields': 'next',
        },
        'success': callback, 
        'error': function(jqXHR, textStatus, errorThrown) {
            console.log('fail', textStatus);
            if (repeat >= 1) {
                repeat--;
                get_data(url, callback, repeat);
                console.log('repeat again, remain', repeat);
            } else {
                $('#loading').css({'display': 'none'});
            }
        },
    });
  }

  // 添加文章到页面
  function add_article(url) {
      // disable the previous article's pageless_scroll_handler
      $(window).off('scroll', pageless_scroll_handler);
      $('#pageless-wrap').remove();
      $('#loading').css({'display': 'block'});
      get_data(url, function (data) {
          page_number = 1;
          data['page_number'] = page_number;

          // render to show
          $('#article').append(
              check_error(data) || 
              $('#article_template').mustache(data, {'page':$('#page_template').html()})
          );

          // next
          lazy_load(data.next);
          $('#loading').css({'display': 'none'});
      });
      return false;
  }

  // 加载下一页
  function add_page(url) {
      $('#loading').css({'display': 'block'});
      get_data(url, function(data) {
          pre_page = $("#page"+page_number);
          data['page_number'] = ++page_number;

          // render to show
          var page = check_error(data) || $("#page_template").mustache(data);
          page.insertAfter(pre_page);

          // next
          lazy_load(data.next);
          $('#loading').css({'display': 'none'});
      });
  }

  // 检查返回的数据
  function check_error(data) {
      return data.error ? $('#error_template').mustache(data) : false;
  }

  // 延时加载
  function lazy_load(url) {
      if (!url) return;
      // next
      if ($(window).height() >= $(document).height())
          add_page(url);// bottom_less_handler
      else
          $(window).on('scroll', {url:url}, pageless_scroll_handler);// scroll_bottom_handler
  }

  // 页面滚动处理程序
  function pageless_scroll_handler(event) {
      if ($(document).scrollTop()+$(window).height() > $(document).height() - 50) {
          $(window).off('scroll', pageless_scroll_handler);
          add_page(event.data.url);
      }
  }

  window.onload = function () {
      //lazy_load($('#next_page').attr('next_page'));
      document.forms.fs.url.focus();

      // info
      window.console = window.console || {};
      console.log || (console.log = opera.postError);
      console.log('pageless源代码可在Github获得\nhttps://github.com/url2/url2-app-samples');

      // url to test
      $('#url-list-pane ul.url-list li').each(function(e,t){
          $(t).on('click', function() {
              add_article($(t).attr('src-data'));
          });
      });
      // show  pane
      $('.show-pane').on('click', function() {
          $('#url-list-pane').animate({
              left: '0px',
          }, 500);
      });
      // close pane
      $('#url-list-pane div.close').on('click', function() {
          $('#url-list-pane').animate({
              left: '-'+(parseInt($('#url-list-pane').css('width'),10)+5)+'px',
          }, 500);
      });
  };
</script>
</body>
</html>
